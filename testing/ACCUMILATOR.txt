#include <Wire.h>
#include <MPU6050.h>
#include <math.h>

MPU6050 accel(0x68);

// Raw accelerometer values
short int axisX, axisY, axisZ;

// G-force values
float xG, yG, zG;
const float gForce = 16384.0;

// Angles
float roll, pitch, tilt;

// Tilt threshold for accident detection
const float accidentTiltThreshold = 50.0; // degrees, tune as needed

void setup() {
  Serial.begin(115200);
  Wire.begin(D2, D1); // SDA, SCL for NodeMCU

  Serial.println("Initializing MPU6050...");
  accel.initialize();

  if (!accel.testConnection()) {
    Serial.println("âš  MPU6050 connection failed, continuing anyway...");
  } else {
    Serial.println("MPU6050 Connected!");
  }
}

void loop() {
  // Read raw acceleration
  accel.getAcceleration(&axisX, &axisY, &axisZ);

  // Convert to g-force
  xG = axisX / gForce;
  yG = axisY / gForce;
  zG = axisZ / gForce;

  // Calculate roll and pitch angles
  roll  = atan2(yG, zG) * 180.0 / PI;
  pitch = atan2(-xG, sqrt(yG*yG + zG*zG)) * 180.0 / PI;

  // Use maximum tilt angle
  tilt = max(abs(roll), abs(pitch));

  // Debug
  Serial.print("Roll: "); Serial.print(roll);
  Serial.print(" | Pitch: "); Serial.print(pitch);
  Serial.print(" | Max Tilt: "); Serial.println(tilt);

  // Accident detection by angle
  if (tilt >= accidentTiltThreshold) {
    Serial.println("ðŸš¨ ACCIDENT/FALL DETECTED!");
    // Here you can trigger buzzer, LED, or alert
  } else {
    Serial.println("Riding normally");
  }

  delay(5000); // fast check for real-time tilt
}
