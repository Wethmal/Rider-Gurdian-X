#include <ESP8266WiFi.h>
#include <Wire.h>
#include <SPI.h>
#include <MPU6050.h>
#include <MFRC522.h>
#include <DHT.h>
#include <Firebase_ESP_Client.h>
#include "addons/TokenHelper.h"
#include "addons/RTDBHelper.h"


#define WIFI_SSID "KP"
#define WIFI_PASSWORD "12345678"


#define API_KEY "AIzaSyDoRLg1zbw56lWy93yCGBYqpOScxbtDV0s"
#define DATABASE_URL "https://iottest-6f78a-default-rtdb.asia-southeast1.firebasedatabase.app/"


FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;


#define SS_PIN D4
#define RST_PIN D3
MFRC522 rfid(SS_PIN, RST_PIN);

MPU6050 accel(0x68);
short int ax, ay, az;
float roll, pitch, tilt;
float xG, yG, zG;
const float gForce = 16384.0;
const float accidentTiltThreshold = 50.0;


#define TRIG_PIN D0  
#define ECHO_PIN D8  


#define DHT_PIN D9  
#define DHT_TYPE DHT11
DHT dht(DHT_PIN, DHT_TYPE);


bool helmetAlreadyDetected = false;


unsigned long lastSensorRead = 0;
const unsigned long sensorInterval = 2000; 

void setup() {
  Serial.begin(115200);
  Wire.begin(D2, D1); 
  SPI.begin();         


  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);

  
  dht.begin();

  
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nConnected to WiFi!");

  
  config.api_key = API_KEY;
  auth.user.email = "admin@gmail.com";
  auth.user.password = "admin123";
  config.database_url = DATABASE_URL;
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  
  rfid.PCD_Init();
  Serial.println("RFID Ready...");

  
  accel.initialize();
  if (accel.testConnection()) Serial.println("MPU6050 Connected!");
  else Serial.println("âš  MPU6050 Not Detected");

  
  helmetAlreadyDetected = false;
  Firebase.RTDB.setBool(&fbdo, "/helmetDetected", false);
  Serial.println("System Boot: Helmet = FALSE");
}

void loop() {

  
  if (rfid.PICC_IsNewCardPresent() && rfid.PICC_ReadCardSerial()) {

    if (!helmetAlreadyDetected) {
      Serial.println("Helmet Detected! âœ” Sending to Firebase...");
      if (Firebase.RTDB.setBool(&fbdo, "/helmetDetected", true))
        Serial.println("âœ… Helmet status updated in Firebase");
      else
        Serial.println("âŒ Firebase Error: " + fbdo.errorReason());

      helmetAlreadyDetected = true;
    } 
    else {
      Serial.println("Helmet already verified. No update sent.");
    }

    rfid.PICC_HaltA();
    rfid.PCD_StopCrypto1();
  }

  
  accel.getAcceleration(&ax, &ay, &az);
  xG = ax / gForce;
  yG = ay / gForce;
  zG = az / gForce;

  roll  = atan2(yG, zG) * 180.0 / PI;
  pitch = atan2(-xG, sqrt(yG*yG + zG*zG)) * 180.0 / PI;
  tilt = max(abs(roll), abs(pitch));

  bool accident = (tilt >= accidentTiltThreshold);

  
  if (Firebase.RTDB.setBool(&fbdo, "/accident", accident)) {
    Serial.println(accident ? "ðŸš¨ Accident Detected!" : "âœ” Normal Riding");
  } else {
    Serial.println("âŒ Firebase Error: " + fbdo.errorReason());
  }

  
  if (accident && helmetAlreadyDetected) {
    helmetAlreadyDetected = false;
    Firebase.RTDB.setBool(&fbdo, "/helmetDetected", false);
    Serial.println("Accident: Helmet reset to FALSE");
  }

  
  if (millis() - lastSensorRead >= sensorInterval) {
    lastSensorRead = millis();

    
    float distance = measureDistance();
    
    
    String proximityStatus = getProximityStatus(distance);
    
  
    if (Firebase.RTDB.setFloat(&fbdo, "/ultrasonic/distance", distance)) {
      Serial.print("ðŸ“ Distance: ");
      Serial.print(distance);
      Serial.println(" cm");
    }
    
    if (Firebase.RTDB.setString(&fbdo, "/ultrasonic/status", proximityStatus)) {
      Serial.print("âš ï¸ Proximity: ");
      Serial.println(proximityStatus);
    }

    
    float temperature = dht.readTemperature(); 
    float humidity = dht.readHumidity();

    if (!isnan(temperature) && !isnan(humidity)) {
      
      if (Firebase.RTDB.setFloat(&fbdo, "/weather/temperature", temperature)) {
        Serial.print("ðŸŒ¡ï¸ Temperature: ");
        Serial.print(temperature);
        Serial.println(" Â°C");
      }
      
      
      if (Firebase.RTDB.setFloat(&fbdo, "/weather/humidity", humidity)) {
        Serial.print("ðŸ’§ Humidity: ");
        Serial.print(humidity);
        Serial.println(" %");
      }

      
      String condition = getWeatherCondition(temperature, humidity);
      if (Firebase.RTDB.setString(&fbdo, "/weather/condition", condition)) {
        Serial.print("â˜ï¸ Condition: ");
        Serial.println(condition);
      }
    } else {
      Serial.println("âŒ Failed to read DHT11 sensor!");
    }
  }

  delay(10); 
}


float measureDistance() {

  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);

  
  long duration = pulseIn(ECHO_PIN, HIGH, 30000); 
  

  float distance = (duration * 0.0343) / 2.0;

  
  if (distance > 400 || distance <= 0) {
    return 400; 
  }
  return distance;
}


String getProximityStatus(float distance) {
  if (distance < 20) {
    return "DANGER";
  } else if (distance < 50) {
    return "VERY CLOSE";
  } else if (distance < 100) {
    return "CLOSE";
  } else if (distance < 200) {
    return "MODERATE";
  } else {
    return "SAFE";
  }
}

String getWeatherCondition(float temp, float humidity) {
  if (temp > 35) {
    return "HOT";
  } else if (temp > 25 && humidity > 70) {
    return "HUMID";
  } else if (temp < 15) {
    return "COLD";
  } else if (humidity > 80) {
    return "RAINY/WET";
  } else if (temp >= 20 && temp <= 30 && humidity < 70) {
    return "COMFORTABLE";
  } else {
    return "NORMAL";
  }
}